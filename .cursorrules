# Liftr - Fitness Tracking App - Cursor AI Rules

## Project Context
This is a Next.js fitness tracking application with Turso SQLite database, Redux state management, and Material UI components.

## üöÄ Git & Workflow Rules

### NEVER Auto-commit or Ask for Commits
- **NEVER commit changes automatically**
- **NEVER ask the user if they want to commit**
- **NEVER run git add, git commit, or git push commands**
- User will handle all git operations manually
- Only exception: User explicitly asks you to commit

## üèóÔ∏è Application Structure

### Directory Organization
```
src/
‚îú‚îÄ‚îÄ app/                      # Next.js App Router pages
‚îÇ   ‚îú‚îÄ‚îÄ login/               # Login page
‚îÇ   ‚îú‚îÄ‚îÄ workouts/            # Workouts management
‚îÇ   ‚îú‚îÄ‚îÄ training-programs/   # Grouped workouts (training programs)
‚îÇ   ‚îú‚îÄ‚îÄ users/               # User management (admin)
‚îÇ   ‚îú‚îÄ‚îÄ progress/            # User progress tracking
‚îÇ   ‚îú‚îÄ‚îÄ recent/              # Recent workouts
‚îÇ   ‚îî‚îÄ‚îÄ api/                 # API routes
‚îú‚îÄ‚îÄ components/              # Reusable UI components
‚îÇ   ‚îú‚îÄ‚îÄ common/             # Common components (Loader, etc)
‚îÇ   ‚îú‚îÄ‚îÄ layout/             # Layout components (Navbar, Sidebar)
‚îÇ   ‚îî‚îÄ‚îÄ features/           # Feature-specific components
‚îú‚îÄ‚îÄ redux/                   # Redux state management
‚îÇ   ‚îú‚îÄ‚îÄ slices/             # Redux slices
‚îÇ   ‚îî‚îÄ‚îÄ store.js            # Redux store configuration
‚îú‚îÄ‚îÄ services/               # Service layer (modular)
‚îÇ   ‚îú‚îÄ‚îÄ database/          # Database abstraction
‚îÇ   ‚îú‚îÄ‚îÄ auth/              # Authentication service
‚îÇ   ‚îî‚îÄ‚îÄ api/               # API client utilities
‚îú‚îÄ‚îÄ lib/                    # Utility libraries
‚îú‚îÄ‚îÄ constants/             # App-wide constants
‚îú‚îÄ‚îÄ styles/                # Global styles and theme
‚îî‚îÄ‚îÄ types/                 # TypeScript types (if using TS)
```

### File Naming Conventions
- **Components**: PascalCase (e.g., `UserTable.js`)
- **Pages**: lowercase with hyphens (e.g., `training-programs`)
- **Styles**: Match component name (e.g., `UserTable.module.css`)
- **Constants**: UPPER_SNAKE_CASE in files named `constants.js`
- **Services**: camelCase (e.g., `authService.js`)

## üîê Security Guidelines

### 1. No Hardcoded Secrets
- ‚ùå Never hardcode API keys, tokens, or passwords
- ‚úÖ Always use environment variables from `.env.local`
- ‚úÖ Sensitive values must be in `.env.local` (gitignored)

### 2. Protected Endpoints
- ‚úÖ All API routes must verify JWT token
- ‚úÖ Admin-only routes must check user role
- ‚úÖ Use middleware for route protection

### 3. Password Security
- ‚úÖ Always hash passwords with bcrypt
- ‚úÖ Never log actual passwords
- ‚úÖ Never return passwords in API responses

### 4. SQL Injection Prevention
- ‚úÖ Always use parameterized queries
- ‚úÖ Never concatenate user input into SQL
- ‚úÖ Use `?` placeholders with args array

### 5. XSS Prevention
- ‚úÖ Sanitize user input before rendering
- ‚úÖ Never use dangerouslySetInnerHTML unless necessary

## üé® UI/UX Guidelines

### Material UI Standards
- Use Material UI components exclusively
- Follow Material Design principles
- Dark theme as default (can be toggled)
- Responsive design (mobile-first)

### Loading States
- Show Material UI `CircularProgress` or `LinearProgress` for all async operations
- Use consistent loader component from `components/common/Loader.js`
- Display skeleton screens for initial page loads

### Theme Configuration
- Primary Color: Deep blue (#1976d2)
- Dark Mode: Dark background with proper contrast
- Use Material UI's `ThemeProvider`
- Store theme preference in localStorage

## üì¶ Redux State Management

### Store Structure
```javascript
{
  auth: {
    user: null | User,
    isAuthenticated: boolean,
    loading: boolean,
    error: string | null
  },
  workouts: {
    items: Workout[],
    loading: boolean,
    error: string | null
  },
  trainingPrograms: {
    items: TrainingProgram[],
    loading: boolean,
    error: string | null
  },
  users: {
    items: User[],
    loading: boolean,
    error: string | null
  }
}
```

### Redux Best Practices
- Use Redux Toolkit (createSlice, createAsyncThunk)
- Keep slices small and focused
- Use selectors for derived state
- Handle loading/error states consistently

## üóÑÔ∏è Database Schema & Indexing

**Important**: All Liftr table names must be prefixed with `liftr_`

### Core Tables
```sql
liftr_users (
  id INTEGER PRIMARY KEY,
  username TEXT UNIQUE,
  password TEXT, -- bcrypt hashed
  name TEXT,
  role TEXT DEFAULT 'user', -- 'user' | 'admin'
  trainerId INTEGER, -- for trainer assignments
  createdAt TEXT,
  lastLogin TEXT
)

liftr_workouts (
  id INTEGER PRIMARY KEY,
  name TEXT,
  equipmentName TEXT,
  equipmentPhoto TEXT, -- URL or base64
  muscleFocus TEXT, -- e.g., 'Chest', 'Legs', 'Back'
  description TEXT,
  createdBy INTEGER, -- user id
  createdAt TEXT
)

liftr_training_programs (
  id INTEGER PRIMARY KEY,
  name TEXT, -- e.g., 'Leg Day', 'Push Day'
  workoutIds TEXT, -- JSON array of workout IDs
  createdBy INTEGER,
  createdAt TEXT
)

liftr_workout_sessions (
  id INTEGER PRIMARY KEY,
  userId INTEGER,
  workoutId INTEGER,
  trainingProgramId INTEGER,
  setNumber INTEGER,
  reps INTEGER,
  weight REAL,
  weightChange REAL,
  rir INTEGER,
  unit TEXT DEFAULT 'lbs',
  completedAt TEXT
)

liftr_active_workouts (
  id INTEGER PRIMARY KEY,
  userId INTEGER,
  trainingProgramId INTEGER,
  workoutData TEXT, -- JSON
  startedAt TEXT
)

liftr_achievements (
  id INTEGER PRIMARY KEY,
  userId INTEGER,
  workoutId INTEGER,
  exerciseName TEXT,
  achievementType TEXT, -- 'weight', 'reps', 'rir'
  previousValue REAL,
  newValue REAL,
  improvement REAL,
  unit TEXT,
  achievedAt TEXT
)
```

### Metadata Tables (For Scalability)
```sql
-- Stores last 10 sessions per workout (lightweight)
liftr_workout_meta (
  id INTEGER PRIMARY KEY,
  userId INTEGER,
  workoutId INTEGER,
  sessionDate TEXT,
  maxWeight REAL,
  avgWeight REAL,
  totalSets INTEGER,
  avgReps REAL,
  avgRir REAL,
  unit TEXT,
  UNIQUE(userId, workoutId, sessionDate)
)

-- Personal records (all-time bests)
liftr_personal_records (
  id INTEGER PRIMARY KEY,
  userId INTEGER,
  workoutId INTEGER,
  recordType TEXT, -- 'max_weight', 'max_reps', 'max_volume'
  recordValue REAL,
  unit TEXT,
  achievedAt TEXT,
  previousRecord REAL,
  UNIQUE(userId, workoutId, recordType)
)

-- Weekly statistics
liftr_weekly_stats (
  id INTEGER PRIMARY KEY,
  userId INTEGER,
  weekStart TEXT, -- YYYY-MM-DD (Monday)
  totalWorkouts INTEGER,
  totalSets INTEGER,
  totalCalories INTEGER,
  musclesWorked TEXT, -- JSON
  UNIQUE(userId, weekStart)
)

-- Monthly statistics
liftr_monthly_stats (
  id INTEGER PRIMARY KEY,
  userId INTEGER,
  month TEXT, -- YYYY-MM
  totalWorkouts INTEGER,
  totalSets INTEGER,
  totalCalories INTEGER,
  avgWorkoutsPerWeek REAL,
  UNIQUE(userId, month)
)
```

### Database Indexing Strategy

**CRITICAL**: Always maintain these indexes for optimal performance

#### Core Workout Indexes (4 indexes)
```sql
-- User's sessions by date (used in /api/home, /api/progress-stats)
CREATE INDEX idx_workout_sessions_user_date 
ON liftr_workout_sessions(userId, completedAt DESC);

-- Program sessions (used in /api/recent-activity)
CREATE INDEX idx_workout_sessions_program_date 
ON liftr_workout_sessions(trainingProgramId, completedAt DESC);

-- Workout-specific sessions (used in comparisons)
CREATE INDEX idx_workout_sessions_workout 
ON liftr_workout_sessions(workoutId, completedAt DESC);

-- User-workout history (used in /api/workout-history)
CREATE INDEX idx_workout_sessions_user_workout 
ON liftr_workout_sessions(userId, workoutId, completedAt DESC);
```

#### Achievement Indexes (3 indexes)
```sql
-- Today's achievements (used in /api/achievements/today)
CREATE INDEX idx_achievements_user_date 
ON liftr_achievements(userId, achievedAt DESC);

-- Exercise-specific achievements
CREATE INDEX idx_achievements_user_workout 
ON liftr_achievements(userId, workoutId, achievedAt DESC);

-- Achievements by type (weight/reps/rir)
CREATE INDEX idx_achievements_user_type 
ON liftr_achievements(userId, achievementType, achievedAt DESC);
```

#### Metadata Indexes (6 indexes)
```sql
-- Workout history (last 10 sessions)
CREATE INDEX idx_workout_meta_user_workout 
ON liftr_workout_meta(userId, workoutId, sessionDate DESC);

-- Recent progress
CREATE INDEX idx_workout_meta_user_date 
ON liftr_workout_meta(userId, sessionDate DESC);

-- Personal records lookup
CREATE INDEX idx_personal_records_user_workout 
ON liftr_personal_records(userId, workoutId, recordType);

-- Recent PRs
CREATE INDEX idx_personal_records_user_date 
ON liftr_personal_records(userId, achievedAt DESC);

-- Weekly statistics
CREATE INDEX idx_weekly_stats_user_week 
ON liftr_weekly_stats(userId, weekStart DESC);

-- Monthly statistics
CREATE INDEX idx_monthly_stats_user_month 
ON liftr_monthly_stats(userId, month DESC);
```

#### Other Indexes (3 indexes)
```sql
-- Active workouts
CREATE INDEX idx_active_workouts_user 
ON liftr_active_workouts(userId, startedAt DESC);

-- Trainer queries
CREATE INDEX idx_users_trainer 
ON liftr_users(trainerId);

-- Workout lookups (for JOINs)
CREATE INDEX idx_workouts_id 
ON liftr_workouts(id);
```

### Indexing Best Practices

1. **Always run `/api/optimize-db` after deployment** to create all indexes
2. **Run `ANALYZE` in Turso console** after creating indexes
3. **When adding new queries**, ensure they use indexed columns in WHERE/ORDER BY
4. **Monitor query performance** - all queries should be < 500ms
5. **If adding new tables**, create corresponding indexes for common queries

### Data Retention Strategy

- **Keep detailed sessions**: Last 30 days only
- **Keep metadata**: Last 10 sessions per workout (forever)
- **Keep PRs**: All-time bests (forever)
- **Keep stats**: Weekly/monthly summaries (forever)
- **Auto-cleanup**: Monthly cron job deletes old sessions, preserves metadata
- **Run cleanup**: `/api/cleanup-old-data` (runs automatically monthly)

### Performance Expectations

With proper indexing:
- Home page: < 200ms
- Progress stats: < 500ms
- Achievements: < 100ms
- Workout history: < 50ms
- Personal records: < 10ms
- Statistics: < 100ms

## üîß Service Layer (Modular)

### Database Service (`services/database/dbService.js`)
- Abstract database operations
- Easy to swap Turso with other databases
- Export: `query`, `execute`, `transaction`

### Auth Service (`services/auth/authService.js`)
- Handle login, logout, token verification
- Easy to swap JWT with other auth methods
- Export: `login`, `verifyToken`, `hashPassword`, `comparePassword`

### API Client (`services/api/apiClient.js`)
- Centralized API calls
- Handle errors and loading states
- Export: `get`, `post`, `put`, `delete`

## üö´ File Creation Rules

### NEVER Create These Files (Unless Explicitly Requested):
- **NEVER create .md files** (README.md, CHANGELOG.md, CONTRIBUTING.md, LICENSE.md, SETUP_GUIDE.md, PROJECT_SUMMARY.md, QUICK_START.md, or ANY .md documentation files)
- **NEVER create .txt summary files**
- **NEVER create .sh test script files**
- **NEVER create documentation files** in any format

### CRITICAL RULE:
**DO NOT CREATE ANY .md FILES UNLESS THE USER EXPLICITLY REQUESTS IT**

### Important:
- Documentation and instructions should ONLY be in code comments or inline JSDoc
- NEVER write separate documentation files
- If you need to explain something, use code comments or respond in chat
- Only create .md files if user says "create a markdown file" or "write a README"

## üéØ Feature Requirements

### Login Page
- Username and password fields
- JWT authentication with 3-month expiry
- Store token in httpOnly cookie
- Redirect to home on success

### Navigation
- Navbar with burger menu icon
- Collapsible sidebar with:
  - Workouts
  - Training Programs
  - Users (admin only)
  - My Progress
  - Recent Workouts
- Active route highlighting

### Workouts Page
- Table/Grid view of all workouts
- Add/Edit/Delete functionality
- Fields: Equipment name, photo, muscle focus
- Search and filter options

### Training Programs Page
- Create grouped workouts
- Select multiple workouts
- Name the program (e.g., "Leg Day")
- Assign to users

### Users Page (Admin Only)
- Material UI DataGrid/Table
- Add new user
- Reset password functionality
- Role management

## üìù Code Quality Rules

### Component Structure
```javascript
// 1. Imports (grouped)
import { useState } from 'react';
import { Button, Box } from '@mui/material';
import { useDispatch } from 'react-redux';
import styles from './Component.module.css';

// 2. Constants
const COMPONENT_CONSTANTS = {};

// 3. Component
export default function Component() {
  // a. Hooks
  // b. State
  // c. Effects
  // d. Handlers
  // e. Render
}
```

### Error Handling
- Always use try/catch for async operations
- Display user-friendly error messages
- Log errors to console in development
- Return appropriate HTTP status codes

### Environment Variables
```bash
# .env.local
TURSO_DATABASE_URL=libsql://liftr_your-db-name.turso.io
TURSO_AUTH_TOKEN=your-turso-token
JWT_SECRET=your-secret-key
JWT_EXPIRY=90d
```

**Important**: All Turso database names must be prefixed with `liftr_`

## üöÄ Deployment Checklist

1. ‚úÖ All environment variables set in Vercel
2. ‚úÖ Initialize database tables (`/api/init-db`)
3. ‚úÖ Initialize metadata tables (`/api/init-meta-tables`)
4. ‚úÖ Create database indexes (`/api/optimize-db`)
5. ‚úÖ Create admin user
6. ‚úÖ Test authentication flow
7. ‚úÖ Verify responsive design
8. ‚úÖ Run `ANALYZE` in Turso console

## üéØ Performance & Scalability

### Lazy Loading Architecture

To prevent timeout errors and ensure fast page loads:

1. **Main data loads first** (< 3 seconds)
   - Home page: `/api/home` returns only essential data
   - Active workouts, today's calories, session count

2. **Heavy data loads lazily** (background, after main load)
   - Progress stats: `/api/progress-stats` (muscle distribution, calories chart)
   - Recent activity: `/api/recent-activity` (last 5 workouts with comparisons)
   - Achievements: `/api/achievements/today` (today's PRs)

3. **Use loading spinners** for lazy sections
   - Show `CircularProgress` while data loads
   - Progressive UI updates as data arrives

### API Endpoint Guidelines

When creating new API endpoints:

- **Select specific columns**, not `SELECT *`
- **Use INNER JOIN** when data must exist
- **Add LIMIT** to prevent excessive data
- **Filter by indexed columns** in WHERE clause
- **Use date ranges** instead of all-time queries
- **Return only needed data** to frontend
- **Set maxDuration** for long-running endpoints

Example:
```javascript
export const maxDuration = 20; // For slow endpoints

const data = await query(
  `SELECT ws.completedAt, w.muscleFocus 
   FROM liftr_workout_sessions ws
   INNER JOIN liftr_workouts w ON ws.workoutId = w.id
   WHERE ws.userId = ? AND ws.completedAt >= ?
   ORDER BY ws.completedAt DESC
   LIMIT 500`,
  [userId, thirtyDaysAgo]
);
```

### Cron Jobs

Vercel cron jobs are configured in `vercel.json`:

```json
{
  "crons": [{
    "path": "/api/cleanup-old-data",
    "schedule": "0 2 1 * *"  // 1st of month, 2 AM
  }]
}
```

- **Cleanup old data**: Runs monthly, deletes sessions > 30 days
- **Preserves metadata**: Keeps last 10 sessions per workout
- **Updates PRs**: Ensures personal records are current
- **Automatic**: No manual intervention needed

## üì± Native Features

### Pull-to-Refresh
- **Component**: `src/components/common/PullToRefresh.js`
- **Usage**: Wrap page content with `<PullToRefresh onRefresh={handleRefresh}>`
- **Enabled On**: Home, Workouts, Training Programs pages
- **Behavior**: Pull down from top of page to refresh data with haptic feedback

### Swipe-to-Go-Back Gesture
- **Hook**: `src/hooks/useSwipeBack.js`
- **Enabled**: Globally in layout.js
- **Behavior**: Swipe from left edge (within 20px) to go back
- **Native Config**: `allowsBackForwardNavigationGestures: true` in capacitor.config.ts

### Haptic Feedback
- **Utilities**: `src/lib/nativeFeatures.js`
- **Available Types**: hapticLight, hapticMedium, hapticHeavy, hapticSuccess, hapticError, hapticWarning
- **Usage**: Import and call directly, or use `<HapticButton>` component
- **Integrated**: Navigation, pull-to-refresh, swipe-back, button interactions

### Status Bar
- **Fixed**: Solid black background (#0a0a0a)
- **Style**: DARK mode
- **Safe Areas**: Proper handling of notch/home indicator
- **No Transparency**: Content never bleeds through

### Skeleton Loaders
- **Component**: `src/components/common/SkeletonLoader.js`
- **Types**: Card, WorkoutCard, Table, Chart, Stats, List, Page, ActiveWorkout
- **Usage**: Show instead of blank screens during loading
- **Implemented**: Home, Workouts, and other key pages

## ‚ö†Ô∏è Important Notes

- **JWT Expiry**: 90 days (3 months)
- **Cookie Security**: httpOnly, secure in production
- **Database**: Turso SQLite (but swappable via service layer)
- **State Management**: Redux Toolkit only
- **UI Library**: Material UI only
- **Theme**: Dark mode by default
- **Refresh Method**: Pull-to-refresh only (no manual refresh buttons)
- **Navigation**: Native swipe-back gesture enabled

---

**Remember**: Modularity is key. Every service should be easily replaceable without affecting the rest of the application.
